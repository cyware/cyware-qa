# Cyware `qa-docs`
Cyware - Quality Assurance automation self-contained documentation parsing tool.

You can visit the `qa-docs` [wiki entry](https://github.com/cyware/cyware-qa/wiki/QADOCS-tool) for a complete guide.

## Rational
Cyware QA documentation is designed to be self-contained into the source code of each test.

`qa-docs` is the tool in charge of parsing the documentation block from each source code and generating data, able
to be indexed and displayed. It has two modules well defined: `DocGenerator` and `SearchUI`.

### DocGenerator

It is the module that parses and indexes the data to ElasticSearch.

### SearchUI

It is a search engine that allows to search and visualize the data previously indexed to ElasticSearch.

## Design
### Input
`DocGenerator` parses the information from test files containing a specific comment format:

Each test file has self-contained documentation comment blocks in **YAML** format.

These blocks can contain **Mandatory** and **Optional** fields.
- **Mandatory** fields must be present in the documentation block and will be added to the final
documentation output files.
- **Optional** fields, if present, will be parsed and added to the final documentation output files.

Each test file has a header docstring that details information related to the whole test file.
And each test method inside the file will have a test documentation block with the specific information of
this test.

The specific content of each block is defined in the [Documentation schema section](https://github.com/cyware/cyware-qa/wiki/Documenting-tests-using-the-qadocs-schema)
within the `qa-docs` wiki.

### Parsing
Running `qa-docs` as specified in the [Usage section](#usage) will scan every test and group file found into the
included paths of the documentation, it will extract the module and tests blocks from each test file and discard any
non-documentable field. Also, complementary test-cases information will be extracted from a dry-run of Pytest if there
isn´t a description for them.

### Output
The parsed and filtered documentation information will be added to the output folder within the `qa-docs` build installation.

Each test file will generate a JSON and a YAML file with the documentation information. Each of these files contains
a structure with the module description and every test function in the module. Each test function
contains its description and, if available, the test-cases information.

These files are ordered in nested folders with the same tree structure as the source code files.

### Sanity Check
After the generation of the documentation output, a sanity check can be executed to identify coverage, tags and
any missing mandatory field.

### Indexing
The JSON files generated by `qa-docs` are intended to be indexed into elasticsearch and later be displayed by the Search-UI App.
So, DocGenerator treats each JSON file as a document that will be added to the ElasticSearch index.

### Local launch
Together with the Indexing functionality, the tool can locally launch SearchUI to visualize the
documentation content into the App UI.

### Diagram
<center><img src="https://github.com/cyware/cyware-qa/wiki/images/qadocs_tool_imgs/qa_docs_diagram.png"></center>

## Content
    ├── cyware-testing
    .   ├── qa-docs
    .   |   ├── dockerfiles
    .   |   │   ├── Dockerfile          | The dockerfile that builds a docker image with the `qa-docs` dependencies properly installed
        |   |   └── entrypoint.sh       | Custom entrypoint to run `qa-docs`
        |   ├── lib
        |   |   ├── __init__.py
        |   │   ├── code_parser.py      | The module in charge of parsing documentation blocks
        |   │   ├── config.py           | The module in charge of parsing the configuration file
        |   |   ├── index_data.py       | The module in charge of the index management
        |   │   ├── pytest_wrap.py      | The module in charge of dry-running Pytest to collect complementary information
        |   │   ├── sanity.py           | The module in charge of performing a sanity check
        |   │   └── utils.py            | The module with utility functions
        |   ├── search_ui               | search-ui module directory
        |   ├── __init__.py
        |   ├── CHANGELOG.md            | Record of all notable changes made 
        |   ├── doc_generator.py        | The main module and the entry point of the tool execution
        |   ├── requirements.txt        | Contains the modules that qa-docs needs
        |   ├── README.MD
        |   ├── schema.yaml             | The configuration file of the tool
        |   └── VERSION.json            | Tool version
        ├── scripts
        |   ├── qa_docs.py              | Tool script used by qa framework
        .   .
        .   .

## Schema
The schema file of the tool is located at **qa-docs/schema.yaml**.

The schema fields are specified in the qa-docs documenting test [wiki](https://github.com/cyware/cyware-qa/wiki/QA-Documentation---How-to-document-a-test-using-Schema-2.0).

## Installation

A [wiki entry](https://github.com/cyware/cyware-qa/wiki/QADOCS-tool-installation-guide) is available with the installation details.

### Dependencies

First of all, the cyware-qa framework must be installed following the [installation section](#installation).
The `requirements.txt` file specifies the required Python modules that need to be installed before running the tool.

Before indexing is mandatory to have `ElasticSearch` up and running. Also, before launching the API is mandatory to have `npm` installed.

#### ElasticSearch installation

##### ES installation on Linux:

- ArchLinux
```
pacman -S elasticsearch
systemctl start elasticsearch.service
```
- Centos
```
yum install elasticsearch-oss.x86_64
systemctl start elasticsearch.service
```
- Ubuntu
```
curl -fsSL https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add - && \
echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | tee -a /etc/apt/sources.list.d/elastic-7.x.list && \
apt update && \
apt install -y elasticsearch && \
systemctl start elasticsearch.service
```

##### ES installation on Windows:
- Using `Chocolatey`(you want to install it, visit https://chocolatey.org/install)

```
choco install elasticsearch
```


##### ES RAM management

- Linux

```
echo "-Xms1g" >> /etc/elasticsearch/jvm.options
echo "-Xmx1g" >> /etc/elasticsearch/jvm.options
```

-  Windows

Add the followings line to `config/jvm.options`:

```
-Xms1g
-Xmx1g
```

`-XmsAm` defines the max allocation of RAM to ES JVM Heap, where A is the amount of MBs you want. You can also
use `-XmsAg` if you mean GBs.

It is recommended to use 1GB as the limit. In some cases, we cant get a time out if we use 256MB.

##### For more options check the official website:

https://www.elastic.co/es/downloads/elasticsearch

#### npm installation

- Ubuntu

```
apt-get update
sudo apt-get install npm
```

- Windows

Windows installer: https://nodejs.org/en/download/ and follow the setup wizard steps.

## Usage

You can parse the tests and run the API with just one command, e.g. `qa-docs --tests-path /path-to-tests/ --type integration --modules test_active_response -il active-response-index`

Also, you can visit the `qa-docs` tool [use guide](https://github.com/cyware/cyware-qa/wiki/QADOCS-tool-use-guide)

### Parsing

#### Complete run
    qa-docs --tests-path /path-to-tests-to-parse/

Using just the `-p, --tests-path` flag, the tool will load the schema file and run a complete parse of the paths in the
configuration to dump the content into the output folder located in the `qa-docs` build directory. e.g: `qa-docs --tests-path /cyware-qa/tests/`

#### Parse specific type(s)
    qa-docs --tests-path /path-to-tests-to-parse/ --types <TYPE1> <TYPE2>

Using `-t, --types` flag you can parse only the tests inside the type(s) folder(s) you want.

#### Parse specific component(s)
    qa-docs --tests-path /path-to-tests-to-parse/ --types <TYPE> --components <COMPONENT1> <COMPONENT2>

Using `-c, --components` flag you can parse only the tests inside the component(s) folder(s) you want. It also needs the type of tests where the tests are located.

#### Parse specific suite(s)
    qa-docs --tests-path /path-to-tests-to-parse/ --types <TYPE> --components <COMPONENT> --suites <SUITE1> <SUITE2>

Using `-s, --suites` flag you can parse only the tests inside the components(s) folder(s) you want.

#### Parse specific module(s)
    qa-docs --tests-path /path-to-tests-to-parse/ --types <TYPE> --components <COMPONENT> --suites <SUITE> -m(--modules) MODULE_NAME1 MODULE_NAME2

Using `-m, --modules` flag you can parse only the modules that you want. The documentation parsed will be printed, if you want to save it you have to use the `-o`
flag and specify the output directory. To parse modules you need to specify their type, component and suite. e.g: `qa-docs -p /cyware-qa/tests/ --types integration --components test_api -s test_config -t test_cache test_cors -o /tmp`.

This option is not compatible with API-related options, because the output is printed or saved with `-o` in a custom directory.

#### Check if test(s) exist
    qa-docs --tests-path /path-to-tests-to-parse/ --types <TYPE> --components <COMPONENT> --suites <SUITE> -e(--exist) MODULE_NAME1 MODULE_NAME2

With this option the tool prints if test(s) do(es) exist.

#### Check if module(s) are documented following qa-docs current schema
    qa-docs -p /path-to-tests-to-parse/ -t <TYPE> -c <COMPONENT> -s <SUITE> -m TEST_NAME1 TEST_NAME2 --check-documentation

With this option the tool prints if test(s) has the expected documentation blocks following the qa-docs schema.

#### Sanity Check
    qa-docs --tests-path /path-to-tests-to-parse/ --sanity-check

Using `--sanity-check`, the tool will run a sanity check of the content in the output folder.

It will check the coverage of the already parsed files in the **output path** comparing it with the tests found within
the **tests path**.

Also, it will validate that the output files have every Mandatory field and check that the documentation parsed has no
wrong values following the `qa-docs` [predefined values](https://github.com/cyware/cyware-qa/wiki/Documenting-tests-using-the-qadocs-schema#pre-defined-values).

#### Debug
    qa-docs --tests-path /path-to-tests-to-parse/ -d

Using `-d`, the tool runs in DEBUG mode, logging extra information in the log file(created within the `qa-docs` build directory) or console output.

#### Version
    qa-docs -v

Using `-v`, the tool will print its current version.

#### Index output data
    qa-docs -i <INDEX_NAME>

Using `-i` option, the tool indexes the content of each file output previously generated as a document into **ElasticSearch**. The name of the index
must be provided as a parameter.

If you want to use the **ES Query API** for index management:

- List your indexes:
```
curl -XGET 'localhost:9200/_cat/indices?v'
```

- Index a JSON:
```
curl -XPOST -H "Content-Type: application/json" localhost:9200/index/type/_bulk --data-binary @data.json
```

- Remove an index:
```
curl -XDELETE localhost:9200/index_name/
```

For detailed API information, you can visit https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html
 and https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html. If you want to research **ES Python Client** you can visit
 https://www.elastic.co/guide/en/elasticsearch/client/python-api/current/index.html.


#### Local api launch using index
    qa-docs -l <INDEX_NAME>

Using `-l` option, the tool launches the application with a previously generated index. The name of the index must be provided as a parameter.

#### Index output data and launch the api
    qa-docs -il <INDEX_NAME>

Using `-il` option, the tool indexes the content of each file output as a document into ElasticSearch and then launches the API. The name of the index must be provided as a parameter. e.g: `qa-docs -p /cyware-qa/tests/ -il qa-tests`. A previous run must be performed, e.g.`qa-docs -p /cyware-qa/tests/` so the output data is previously generated.

### Sample executions

- Complete tests directory parse
```
qa-docs --tests-path /path-to-tests/
```

- Parse `fim` component
```
qa-docs --tests-path /path-to-tests/ --type integration --components test_fim
```

- Parse api `config` and `rbac` suites
```
qa-docs --tests-path /path-to-tests/ --type integration --components test_api --suites test_config test_rbac
```

- Parse some `logtest` modules 
```
qa-docs --tests-path /path-to-tests/ --type integration --components test_logtest --suites test_invalid_token --modules test_invalid_session_token
```

- Check if some `logtest` modules has documentation blocks
```
qa-docs -p /path-to-tests/ --type integration --components test_logtest --suites test_configuration --modules test_configuration_file test_get_configuration_sock --check-documentation
```

- Index the parsed data
```
qa-docs -i my_index
```

- Launch `search-ui`
```
qa-docs -l my_index
```

- Parse `vulnerability_detector` component, index the output data, and launch `search-ui`
```
qa-docs --tests-path /path-to-tests/ --type integration --components test_vulnerability_detector -il vd-index
```

## Docker deployment

If you prefer, you can run `qa-docs` using a docker container, that allows you to use `qa-docs` without installing ElasticSearch and npm. You need to run `qa-docs` as if you would do in local but need to specify the branch you want to use as tests input with `--qa-branch` and the flag `--docker-run`.

Few examples:

- Parse `test_active_response` tests and generate the documentation in `/tmp/qa_docs`:
```bash
qa-docs --docker-run --types integration --components test_active_response  --qa-branch 1796-migrate-doc-active-response
```

- Parse `test_fim` tests and generate the documentation in custom folder:
```bash
qa-docs --docker-run --types integration --components test_fim -o /tmp/fim_docu --qa-branch 1796-migrate-doc-active-response
```

- Parse `test_active_response` and `test_agentd` tests and launch search-ui to visualize the documentation:
```bash
qa-docs --docker-run --types integration --components test_active_response test_agentd -il qa-index --qa-branch 1796-migrate-doc-schema-2
```
